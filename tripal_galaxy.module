<?php
/**
 * @file
 * This file contains all Drupal hooks for the module other than any
 * node hooks and block hooks. Those go in the [module name].chado_node.inc file
 * and [module_name].blocks.inc respectively
 *
 */

require ('theme/tripal_galaxy.theme.inc');

/**
 * Implementation of hook_init()
 */
function tripal_galaxy_init() {
  global $user;

  $library = libraries_detect('blend4php');
  if (user_access('administer galaxy', $user)) {
    if (!$library) {
      drupal_set_message(t('The blend4php library is not installed. The Galaxy module requires it.'), 'warning');
    }
  }
}



/**
 * Implements hook_libraries_info().
 *
 * For defining external libraries.
 */
function tripal_galaxy_libraries_info() {

  // A very simple library. No changing APIs (hence, no versions), no variants.
  // Expected to be extracted into 'sites/all/libraries/simple'.
  $libraries['blend4php'] = array(
    'name' => 'blend4php',
    'vendor url' => 'https://github.com/galaxyproject/blend4php',
    'download url' => 'https://github.com/galaxyproject/blend4php',
    'version arguments' => array(
      'file' => 'version.txt',
      'pattern' => '/^(.*)$/',
      'lines' => 1,
    ),
    'files' => array(
      'php' => array('galaxy.inc'),
    ),
  );

  return $libraries;
}


/**
 * Implementation of hook_permissions()
 *
 * Set the permission types that this module uses.
 *
 * @ingroup tripal_file
 */
function tripal_galaxy_permission() {
  return array (
    'use galaxy' => array (
      'title' => t ( 'Execute Published Galaxy Workflows' ),
      'description' => t ( 'Allows a user to submit a published workflow for execution on a remote Galaxy Instance' )
    ),
    'administer galaxy' => array (
      'title' => t ( 'Administer Galaxy' ),
      'description' => t ( 'Allows a user to configure site-wide default Galaxy instances.' )
    )
  );
}

/**
 * Implements hook_menu()
 *
 * Specifies menu items and URLs used by this module.
 *
 * @ingroup tripal_galaxy
 */
function tripal_galaxy_menu() {
  $items = array ();

  // EXPLANATION: all extension modules should have an administrative menu item
  // with the path set to 'admin/tripal/extension/[module name]'.
  $items['admin/tripal/extension/galaxy'] = array (
    'title' => 'Manage Galaxy Instances',
    'description' => 'Integrate workflows from a remote Galaxy instance with this Tripal site',
    'page callback' => 'tripal_galaxy_admin_home',
    'access arguments' => array('administer galaxy'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/tripal_galaxy.admin.inc',
    'file path' => drupal_get_path ('module', 'tripal_galaxy')
  );

  // Edit Galaxy
  $items['admin/tripal/extension/galaxy/edit/%'] = array (
    'description' => 'Edit a galaxy instance',
    'page callback' => 'drupal_get_form',
    'page arguments' => array ('tripal_galaxy_admin_configuration_form', 5),
    'access arguments' => array ('administer galaxy'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/tripal_galaxy.admin.inc',
    'file path' => drupal_get_path ( 'module', 'tripal_galaxy' )
  );

  // Add Galaxy
  $items['admin/tripal/extension/galaxy/add'] = array (
    'description' => 'add a galaxy instance',
    'title' => 'Add Galaxy Instance',
    'page callback' => 'drupal_get_form',
    'page arguments' => array (
      'tripal_galaxy_admin_configuration_form'
    ),
    'access arguments' => array (
      'administer galaxy'
    ),
    'type' => MENU_LOCAL_ACTION,
    'file' => 'includes/tripal_galaxy.admin.inc',
    'file path' => drupal_get_path ( 'module', 'tripal_galaxy' )
  );

  // Available Workflows
  $items['admin/tripal/extension/galaxy/available_wf'] = array(
    'title' => 'Workflows',
    'description' => 'Lists the available workflows for the user',
    'page callback' => 'drupal_get_form',
    'page arguments' => array(
      'tripal_galaxy_admin_available_wf_form',
    ),
    'access arguments' => array (
      'administer galaxy'
    ),
    'type' => MENU_LOCAL_TASK,
    'file' => 'includes/tripal_galaxy.admin_wf_form.inc',
    'file path' => drupal_get_path('module', 'tripal_galaxy')
  );

  // Add Workflows
  $items['admin/tripal/extension/galaxy/available_wf/add_wf'] = array(
    'title' => 'Add Workflows',
    'description' => 'Add workflows to the site given the remote galaxy instance',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tripal_galaxy_admin_add_wf_form'),
    'access arguments' => array('administer galaxy'),
    'type' => MENU_LOCAL_ACTION,
    'file' => 'includes/tripal_galaxy.admin_wf_form_add.inc',
    'file path' => drupal_get_path('module', 'tripal_galaxy' )
  );

  // Remove Workflows
  $items['admin/tripal/extension/galaxy/available_wf/remove/%'] = array (
    'description' => 'Remove a Workflow from site',
    'page callback' => 'tripal_galaxy_admin_remove_wf',
    'page arguments' => array(6),
    'access arguments' => array('administer galaxy'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/tripal_galaxy.admin.inc',
    'file path' => drupal_get_path ( 'module', 'tripal_galaxy' )
  );
  
/*     // Test the invoke functionalityw
  $items['test_invoke'] = array(
    'title' => 'Testing_Invoke',
    'description' => 'Testing the invoke function with a wbeform nid of 223',
    'page callback' => 'tripal_galaxy_invoke',
    'access arguments' => array('administer galaxy'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/tripal_galaxy.webform.inc',
    'file path' => drupal_get_path('module', 'tripal_galaxy' )
  ); */

  // Usage
  $items['admin/tripal/extension/galaxy/usage'] = array (
    'title' => 'Usage',
    'description' => 'Explore Galaxy usage details.',
    'page callback' => 'drupal_get_form',
    'page arguments' => 'tripal_galaxy_admin_usage_form',
    'access arguments' => array (
      'administer galaxy'
    ),
    'type' => MENU_LOCAL_TASK,
    'file' => 'includes/tripal_galaxy.admin.inc',
    'file path' => drupal_get_path ( 'module', 'tripal_galaxy' )
  );

  // Submitted
  $items['admin/tripal/extension/galaxy/submitted'] = array (
    'title' => 'Submitted',
    'description' => 'View Submitted workflows',
    // Are we sure about this?
    'page callback' => 'tripal_galaxy_admin_submitted_list',
    'access arguments' => array (
      'administer galaxy'
    ),
    'type' => MENU_LOCAL_TASK,
    'file' => 'includes/tripal_galaxy.admin.inc',
    'file path' => drupal_get_path ( 'module', 'tripal_galaxy' )
  );

  // Workflow
  $items['workflows'] = array (
    'title' => 'Available Workflows',
    'description' => 'A list of available analytical workflows for this site',
    // Are we sure about this?
    'page callback' => 'test_webforms',
    'access arguments' => array (
      'administer galaxy'
    ),
    'type' => MENU_LOCAL_TASK,
    'file' => 'includes/tripal_galaxy.user.inc',
    'file path' => drupal_get_path ( 'module', 'tripal_galaxy' )
  );

  // Galaxy
  $items['user/galaxy'] = array (
    'title' => 'Galaxy',
    'description' => 'Configure Galaxy Server',
    // Are we sure about this?
    'page callback' => 'drupal_get_form',
    'page arguments' => 'tripal_galaxy_user_configuration_form',
    'access arguments' => array (
      'use galaxy'
    ),
    'type' => MENU_LOCAL_TASK,
    'file' => 'includes/tripal_galaxy.user.inc',
    'file path' => drupal_get_path ( 'module', 'tripal_galaxy' )
  );

  return $items;
}

/**
 * Implements hook_views_api()
 *
 * This hook tells drupal that there is views support for
 * for this module which then automatically includes the tripal_db.views.inc
 * where all the views integration code is found.
 *
 * @ingroup tripal_galaxy
 */
function tripal_galaxy_views_api() {
  return array (
    'api' => 3.0
  );
}

/**
 *  We need to let drupal know about our theme functions and their arguments.
 *  We create theme functions to allow users of the module to customize the
 *  look and feel of the output generated in this module
 *
 * @ingroup tripal_galaxy
 */
function tripal_galaxy_theme($existing, $type, $theme, $path) {
  $items = array (
    'tripal_galaxy_admin_add_wf_form_rows' => array (
      'render element' => 'form'
    ),

    'tripal_galaxy_admin_available_wf_form_rows' => array(
      'render element' => 'form'
    )

  );
  return $items;
}


/**
 * 
 * @param  $form
 * @param  $form_state
 * @param  $form_id
 */
function tripal_galaxy_form_alter(&$form, &$form_state, $form_id ) {
  
  // Check to make sure we have the right form_state
  if(!array_key_exists('webform', $form_state)){
    dpm("I don't have a webform;");
    return;
  }
  
  if(!array_key_exists('component_tree', $form_state['webform']) ){
    dpm("I don't have a component tree");
    return;
  }
  
  if(!array_key_exists('children', $form_state['webform']['component_tree'])){
    dpm("I don't have children");
    return;
  }
  
  if(count($form_state['webform']['component_tree']['children']) < 1){
    dpm("I have too few children");
    return;
  }
  
  $webform = $form_state['webform']['component_tree']['children'];
  dpm("Here is my webform:");
  dpm($form_state);
  
  // If the form is a galaxy webform, it should have a [Galaxy Webform] tag
  if ($webform[1]['form_key'] == 'galaxy_webform') {
    $form['#submit'] = array('tripal_galaxy_execute_workflow');
    dpm($form);
  } 
  
}


/**
 * The function responsible for overriding the webform's submit handler 
 * 
 * @param unknown $form
 * @param unknown $form_state
 */
function tripal_galaxy_execute_workflow($form, &$form_state){
  $parameters = tripal_galaxy_gather_params($form, $form_state);
  $inputs = tripal_galaxy_gather_inputs($form, $form_state);
}

function tripal_galaxy_gather_inputs($form, &$form_state){
  
}

/**
 * Gathers tool parameters from a given $webform.
 * 
 * @param multi-variable $webform
 * 
 * @return 
 *   An array of tool parameters to be used with the blend4php galaxy_invoke function
 */
function tripal_galaxy_gather_params($form, &$form_state) {
  drupal_set_message("I did it!");
  
  
  $webform_components = $form_state['webform']['component_tree']['children'];
 
  // To run the workflow, we need:
  // 0) Workflow id
  // 0.5) Optionally a history id
  // 1) Tool's index in workflow
  // 2) Tool's parameter name
  // 3) Tool's parameter value
  $parameters = array ();
  $tool_index = 0;
  $tool_param_name = 0;
  $tool_param_value = 0;
  
  // The form key element of the webform_component is what is used to attain the name of
  // the webform element. Example: Step_8_41
  // right now format is: Step_<step_number>_<param_name>
  $form_key = 0;
  
  $the_queue = array();
  
  // Iterate through all of the components
  foreach ($webform_components as $webform_component) {
    
    dpm("Current component:");
    dpm($webform_component);
    
    // Add the webform component to the queue.
    $the_queue[] = $webform_component;
    
    // Parse all of the child values. 
    foreach( $webform_component['children'] as $child_component) {
      // Become the most base child. 
      while ( array_key_exists ( 'children', $child_component ) ) {
        $child_component = $child_component['children'];
      }
    }
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    }
    $form_key = $webform_component['form_key'];
    $matches = array ();
    
    // Obtain the tool_index,
    $tool_index = preg_match ( '/^Step_(\d+)/', $form_key, $matches );
    
    // Check to make sure we've matched with a valid tool_index
    if ($tool_index == - 1 || count ( $matches ) == 0) {
      continue;
    }
    
    
    
    $tool_index = $matches[1];
    $tool_index --;
    
    $matches = array ();
    
    // Obtain tool parameter name
    $tool_param_name = preg_match ( '/^Step_\d+_(.+)/', $form_key, $matches );    
    
    // Check to make sure we have a valid parameter name
    if ($tool_param_name == - 1 || count ( $matches ) == 0) {
      continue;
    }
    
    $tool_param_name = $matches[1];
           
    $tool_param_value = $webform_component['value'];
    
    dpm ( "Here is the tool param value:" );
    dpm ( $tool_param_value );
    
    // If the value is okay, add it to the parameters list
    if(filter_cases($tool_param_value)){
      dpm("Adding to parameters: ");
      dpm($tool_param_value);
      $array2 = array($tool_param_name => $tool_param_value);
      if(empty($parameters[$tool_index])){
        $parameters[$tool_index] = array();
      }
      $parameters[$tool_index] = array_merge($parameters[$tool_index], $array2);
    }
  
  }
  
   dpm("The parameters are: ");
   dpm($parameters);
  
   $parameters = array(
    '3' => array('descr_columns' => "17"),
    '4'=> array('convert_from'=> "Co" , 
                 'strip'=>false),
    '5' => array('columnList' => "c1,c7"),
   );
   dpm( "The correct format is: " );
   dpm( $parameters );

}


/**
 * A function to filter the different cases for the values returned by the tools.
 *   returns true if the value entered is a valid value to enter in the invoke_workflow
 *   parameters. 
 *   
 */
function filter_cases($value){
  
  $matches = array();

   if($value ===''){
      
     return FALSE;
     
    }
    
   // If the valuie contains any html,  it is not a valid value.
   if(strpos($value, "<p>") !== FALSE) {
      
     return FALSE;
   
   }
   
   if (strpos($value, "<string>") !== FALSE) {
      
     return FALSE;
   
   }
   
   if (strpos($value, "<label>") !== FALSE) {
      
     return FALSE;
   
   }

  return TRUE;
  
}


/**
 * Implements hook_help()
 *
 * Adds a help $formpage to the module list
 */
function tripal_galaxy_help($path, $arg) {

  // EXPLANATION: in the tripal_galaxy_menu() function above we created
  // a menu item for the help documentation. The menu item specified
  // a function that should be called when the menu item is clicked. This
  // is that function. But, rather than place HTML code in this function
  // we want to have our help documentation in a template galaxy. We
  // specified in the tripal_galaxy.theme() function that we have a template
  // galaxy so now we want to use get the contents of that template galaxy and
  // return it.
  if ($path == 'admin/help#tripal_galaxy') {
    return theme ( 'tripal_galaxy_help', array () );
  }
}